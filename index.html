<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cutter–Sanborn • Ficha catalográfica (módulo Cutter)</title>
  <meta name="description" content="Busca da notação de autor (Cutter–Sanborn) com normalização e pareamento por anterior imediato. Interface acessível e responsiva." />
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <a class="skip-link" href="#busca">Pular para a busca</a>

  <header class="wrap head" role="banner" aria-label="Cabeçalho">
    <div class="brand">
      <div class="logo" aria-hidden="true">C</div>
      <h1>Cutter–Sanborn • Busca rápida</h1>
    </div>
  </header>

  <main class="wrap" role="main">
    <section class="intro" aria-labelledby="regras-title">
      <h2 id="regras-title">Regras rápidas de aplicação</h2>
      <p class="tip">
        Regra prática: até 3 autores (inclusive entidade coletiva) → <strong>entre pelo 1º autor</strong> (sobrenome).
        Se a obra for entrar <strong>pelo título</strong>, digite o título <em>sem</em> artigos iniciais.
      </p>

      <table role="table" aria-describedby="regras-title">
        <thead>
          <tr><th scope="col">CASO</th><th scope="col">CUTTER PARA…</th><th scope="col">INICIAL DA OBRA?</th></tr>
        </thead>
        <tbody>
          <tr><td>Até 3 autores <span class="small">(inclusive entidades coletivas)</span></td><td>1º autor / entidade</td><td>sim</td></tr>
          <tr><td>+ 3 autores, coletâneas (ed., org., comp.), autoria desconhecida, audiovisual, recurso contínuo, obras sagradas &amp; evento</td><td>título</td><td>não</td></tr>
          <tr><td>Crítica e análise de personalidade</td><td>criticado</td><td><span class="kbd">Z</span></td></tr>
          <tr><td>Biografia</td><td>biografado</td><td>inicial do biógrafo</td></tr>
          <tr><td>Autobiografia</td><td>biografado</td><td><span class="kbd">a</span></td></tr>
          <tr><td>Escritos sagrados</td><td>tradutor</td><td>não</td></tr>
          <tr><td>Legislação</td><td>jurisdição</td><td>sim</td></tr>
        </tbody>
      </table>
    </section>

    <section class="search" aria-labelledby="busca-title">
      <h2 id="busca-title">Buscar notação de autor</h2>

      <div class="controls" id="busca">
        <div class="field">
          <label for="q">Digite o sobrenome do 1º autor <span class="small">ou</span> o título (sem artigos iniciais)</label>
          <input id="q" type="text" inputmode="latin-name" autocomplete="off" spellcheck="false" aria-describedby="busca-help" />
          <div id="busca-help" class="small">
            Ex.: <span class="kbd">Escorel</span>, <span class="kbd">Vivências</span>, <span class="kbd">Saint-Exupéry</span>, <span class="kbd">O’Neill</span>.
          </div>
        </div>
      </div>

      <div class="answer" id="answer" role="region" aria-live="polite" aria-label="Resposta da busca">
        <h3>Resposta</h3>
        <div class="ansrow">
          <div>
            <div class="bigcode" id="bestCode" aria-live="polite">—</div>
            <div class="bigkey" id="bestKey">Digite para ver o resultado…</div>
          </div>
          <div>
            <button class="copy" id="copyBtn" type="button" aria-label="Copiar cutter" disabled>Copiar cutter</button>
          </div>
        </div>
        <div class="small" id="explain"></div>
        <div class="small" id="wvWarn" style="display:none;">
          Este visualizador pode bloquear JavaScript. Abra em um navegador (Chrome, Firefox, Safari) para usar a busca.
        </div>
      </div>

      <div id="results" role="region" aria-live="polite" aria-label="Alternativas"></div>
    </section>
  </main>

  <footer role="contentinfo">
    Desenvolvido por <strong>Bernardo Vechi</strong><br/>
    Segue diretrizes de acessibilidade WCAG 2.1 e governo eletrônico.
  </footer>

  <!-- Loader: conecta layout + lógica + dataset externo -->
<script type="module">
  // Imports corretos (arquivos na raiz do repo)
  import * as Normalizer from './normalizer.js';
  import * as Matcher from './matcher.js';
  import { setupUI } from './ui.js';

  const bestCode = document.getElementById('bestCode');
  const bestKey  = document.getElementById('bestKey');
  const explain  = document.getElementById('explain');

  async function boot(){
    try {
      // Caminho relativo à raiz do site do GitHub Pages: /cutter-sanborn/data/cutter-sanborn.json
      const resp = await fetch('./data/cutter-sanborn.json?cachebust=' + Date.now(), { cache: 'no-store' });
      if (!resp.ok) throw new Error('Falha ao carregar data/cutter-sanborn.json (' + resp.status + ')');
      const DATA = await resp.json();
      if (!Array.isArray(DATA) || DATA.length === 0) throw new Error('Dataset vazio ou inválido');

      // Cria índice usando o normalizador (autor por padrão)
      const index = Matcher.buildIndex(DATA, Normalizer);
      if (!Array.isArray(index) || index.length === 0) throw new Error('Índice não foi criado');

      // Liga a UI
      setupUI({ index, Normalizer, Matcher });

      // (opcional) expõe um teste rápido no console:
      window.__dbg = (s) => {
        const n = Normalizer.fromAuthor(String(s||''));
        const m = Matcher.findBest(n, index);
        console.log({query:s, norm:n, match:m});
        return m;
      };
    } catch (err) {
      console.error(err);
      if (bestCode) bestCode.textContent = '—';
      if (bestKey)  bestKey.textContent  = 'Erro ao carregar dados';
      if (explain)  explain.textContent  = String(err.message || err);
    }
  }
  boot();
</script>
</body>
</html>
